# Sql注入漏洞

sql注入发生的地方:数据库层\
\
选择题关键字\
用一些异常的数据看有没有异常：id=‘\
用条件表达式判断有没有异常：id=1 and 1=1         id=1 and 1=2

利用SQL注入漏洞进行攻击的一般步骤包括：识别注入点、构造恶意输入、执行非预期查询、获取敏感数据或执行恶意操作。防御措施包括对用户输入进行严格的验证和过滤、使用参数化查询或预编译语句、限制数据库用户的权限等。

**产生原因** \
本质上是程序员没有遵循代码与数据分离原则 使用户数据作为代码执行

> 当web应用向后台数据库传递SQL语句进行数据库操作时，如果对用户输入的参数没有经过严格的过滤处理，那么攻击者就可以构造特殊的SQL语句，直接输入数据库引擎执行，获取或修改数据库中的数据。

**攻击方式/类型** \
类型有 字符型或者数字型\
sql的注入可以分为数字型，字符型。 简单分辨方法：

看\斜杠后面跟着的字符，是什么字符，它的闭合字符就是什么，若是没有，就为数字型。

数字型 测试步骤：

1、加单引号，URL：xxx.xxx.xxx/xxx.php?id=3'；

对应的sql：select \* from table where id=3' 这时sql语句出错，程序无法正常从数据库中查询出数据，就会抛出异常；

2、加and 1=1 ，URL：xxx.xxx.xxx/xxx.php?id=3 and 1=1；

对应的sql：select \* from table where id=3' and 1=1 语句执行正常，与原始页面没有差异；

3、加and 1=2，URL：xxx.xxx.xxx/xxx.php?id=3 and 1=2；

对应的sql：select \* from table where id=3 and 1=2 语句可以正常执行，但是无法查询出结果，所以返回数据与原始网页存在差异；

字符型 测试步骤：

1、加单引号：select \* from table where name='admin''；

由于加单引号后变成三个单引号，则无法执行，程序会报错；

2、 加 ' and 1=1 此时sql 语句为：select \* from table where name='admin' and 1=1' ，也无法进行注入，还需要通过注释符号将其绕过；

因此，构造语句为：select \* from table where name ='admin' and 1=--' 可成功执行返回结果正确；

3、 加and 1=2— 此时sql语句为：select \* from table where name='admin' and 1=2–'则会报错；

如果满足以上三点，可以判断该url为字符型注入。

1. get注入 在get传参时写入参数，将SQl语句闭合，后面加写入自己的SQL语句。
2. post注入 通过post传参，原理与get一样，重要的是判断我们所输入的信息是否与数据库产生交互，其次判断SQL语句是如何闭合的。
3. 有些网站通过查询cookie判断用户是否登录，需要与数据库进行交互，我们可以修改cookie的值，查找我们所需要的东西。或者通过报错注入是网页返回报错信息。
4. Referer注入 Referer正确写法应该是Referrer,因为http规定时写错只能将错就错，有些网站会记录ip和访问路径，例如百度就是通过Referer来统计网站流量，我们将访问路径进行SQL注入，同样也可以得到想要的信息。
5. XFF注入 在用户登录注册模块在 HTTP 头信息添加 X-Forwarded-for: 9.9.9.9' ，用户在注册的时候，如果存在安全隐 患，会出现错误页面或者报错。从而导致注册或者登录用户失败。 burpsuite 抓包，提交输入检测语句：

```
X-Forwarded-for: 127.0.0.1'and 1=1#
X-Forwarded-for: 127.0.0.1'and 1=2#
//两次提交返回不一样，存在 SQL 注入漏洞
```

6. UA注入：输入点在User-Agent



**如何预防** \
为了防止 SQL 注入攻击，可以采取以下几种防御方式：

1. **使用参数化查询（Prepared Statements）**：
   * 使用参数化查询是最有效的防御 SQL 注入的方法之一。参数化查询使用占位符（如 `?`）代替直接将用户输入嵌入到 SQL 查询中，然后将参数与查询分离，确保用户输入不会被当作 SQL 代码执行。
2. **输入验证与过滤**：
   * 对于用户输入的数据，进行严格的输入验证和过滤，只接受预期的数据格式和范围。例如，对于数字输入，确保只包含数字字符；对于字符串输入，可以使用白名单过滤非法字符。
   * 在应用程序的前端和后端都进行输入验证，防止恶意输入进入系统。
3. **最小权限原则（Least Privilege Principle）**：
   * 遵循最小权限原则，为数据库用户分配最小必要的权限。应用程序连接数据库时，使用有限权限的数据库账号，避免使用具有过高权限的账号。
4. **避免拼接 SQL 语句**：
   * 避免将用户输入直接拼接到 SQL 查询语句中。即使对于动态构建的查询，也应该使用参数化查询或者安全的 ORM（对象关系映射）工具，而不是手动拼接字符串。
5. **ORM 框架的使用**：
   * 使用 ORM 框架（如Hibernate、Entity Framework等）可以帮助自动化地处理数据库访问和数据映射，减少手动编写 SQL 查询的机会，从而降低 SQL 注入的风险。
6. **安全编码实践**：
   * 培训开发人员和测试人员，提高他们对安全编码的认识，编写安全的代码和进行安全审计。
   * 定期更新和维护应用程序和数据库系统，及时修复已知的安全漏洞。
7. **监控与日志记录**：
   * 实施安全监控和日志记录机制，及时发现和响应潜在的 SQL 注入攻击行为。
8. **安全审计**：
   * 定期进行安全审计和漏洞扫描，及时发现并修复存在的安全问题。

